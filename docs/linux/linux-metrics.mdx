---
id: linux-metrics
title: Linux Metrics
sidebar_label: Metrics
---

import { ProjectMagicLink } from "@site/src/components/ProjectMagicLink";

## Introduction

The `collectd` plugin for `memfaultd` (see [the source
code][source-memfaultd-collectd-plugin]) configures CollectD to regularly upload
collected metrics to Memfault. These metrics:

- Are shown on the [device timeline][docs-timeline].
- Are available for use as [Timeseries][docs-timeseries] or
  [Attributes][docs-attributes] metrics, aggregated across the entire fleet.
- Can be used to create [Metric Charts][docs-metric-charts] and
  [Alerts][docs-alerts].

See [Metrics and Attributes](/docs/platform/metrics) for an introduction to
Memfault terminology related to metrics and to learn how the features you'll set
up here can be accessed in the Memfault Web App.

## Prerequisites

### The `memfaultd` daemon

Follow the [getting-started guide][docs-linux-getting-started] to learn how to
set this up for your device. A key function of `memfaultd` is to correctly
configure and control CollectD to upload metrics to Memfault.

:::tip

Keep [`meta-memfault-example`][source-yocto-example] open as a reference
implementation. Your integration should look similar to it once you're done
following the steps in this tutorial.

:::

### Dependencies

#### CollectD

If you're using Yocto, the `meta-oe` layer includes [a recipe for
`collectd`][source-collectd-recipe], so you may be able to just add `collectd`
to your dependencies, e.g. by appending it to `IMAGE_INSTALL`. In our example
project, we've opted for adding it to `MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS` in
[`layer.conf`][source-layer-conf].

[source-collectd-recipe]:
  https://github.com/openembedded/meta-openembedded/tree/master/meta-oe/recipes-extended/collectd

#### Optional: StatsD

[StatsD][statsd-homepage] clients can be configured to talk to CollectD using
[the StatsD plugin][collectd-plugin-statsd]. This will allow you to send
application metrics through to Memfault.

You can find a list of StatsD clients for a diversity of languages [in the
StatsD repository][statsd-clients].

In our example project, we've added StatsD clients as dependencies:

- `statsd-c-client` in our C sample app:
  - See [the corresponding `DEPENDS` addition][source-statsd-c-bb]
  - See a [sample recipe for `statsd-c-client`][source-statsd-c-client-bb]
- `python3-statsd` in our Python sample app:
  - See [the corresponding `DEPENDS` addition][source-statsd-python-bb]

[source-statsd-python-bb]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault-example/recipes-memfault/statsd-sampleapp-c/statsd-sampleapp-c.bb
[source-statsd-c-bb]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault-example/recipes-memfault/statsd-sampleapp-c/statsd-sampleapp-c.bb
[source-statsd-c-client-bb]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault-example/recipes-memfault/statsd-c-client/statsd-c-client.bb
[collectd-plugin-statsd]: https://collectd.org/wiki/index.php/Plugin:StatsD
[statsd-homepage]: https://github.com/statsd/statsd
[statsd-clients]:
  https://github.com/statsd/statsd/blob/master/docs/client_implementations.md

## Configuring CollectD

We strongly recommend familiarizing yourself with [CollectD][collectd-homepage]
and how it's configured in order to make the best use of the Memfault platform.

The `memfaultd` daemon generates a configuration file, by default in
`/tmp/collectd.conf`, with information about the device provided by
[`memfault-device-info`][docs-memfault-device-info] (see the [getting-started
guide][docs-linux-getting-started] for more information). Note that the path
where this configuration file is generated [can be configured in
`/etc/memfaultd.conf`][docs-configuration] using the
`collectd_plugin.output_file` configuration key.

A minimal configuration file to configure CollectD to post to Memfault looks
like this:

```conf
Interval 3600

# Your configuration here.

Include "/tmp/collectd.conf" # Or the value of your collectd_plugin.output_file
```

If you inspect the generated `/tmp/collectd.conf` file, you'll find that it
simply configures the `write_http` plugin to talk to Memfault.

:::warning TODO

Specify how to configure `Interval` in conjunction with Memfault's flush
interval (TBD)

:::

### Recommended configuration

See [our recommended CollectD configuration in
`meta-memfault-example`][source-recommended-collectd-conf].

This configuration makes use of standard plugins that enjoy special support on
the Memfault platform...

:::warning TODO

Specify the plugins in use (TBD)

:::

## Set `enable_data_collection`

By default, `enable_data_collection` is `false` (see the [default
configuration][source-builtin-conf]). This is to enable asking end users for
consent before collecting or transmitting any data to Memfault services.

Once the end user has given their consent, you can enable data collection like
so:

```shell
$ memfaultd --enable-data-collection
```

To disable it:

```shell
$ memfaultd --disable-data-collection
```

The `memfaultd` service will restart automatically whenever you run either of
those commands.

Take a look at the [`/etc/memfaultd.conf` reference][docs-configuration] for
more information.

## Application metrics

First, make sure you've followed [the prerequisites section](#prerequisites) and
installed a StatsD client for your application.

Enable the `statsd` plugin in your `/etc/collectd.conf` (note that this is
already included in the
[recommended configuration](#recommended-configuration)):

```
LoadPlugin statsd
```

The [StatsD plugin][collectd-plugin-statsd] exposes a UDP port (by default
`8125`). You'll need to configure your StatsD client to talk to it. Read on to
see some examples.

### Example: using C

See [the full module in our example layer][statsd-c-example].

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <statsd-client.h>
#include <unistd.h>

#define MAX_LINE_LEN 200
#define PKT_LEN 1400

int main(int argc, char *argv[])
{
  statsd_link *link;

  link = statsd_init_with_namespace("localhost", 8125, "mycapp");

  char pkt[PKT_LEN] = {'\0'};
  char tmp[MAX_LINE_LEN] = {'\0'};

  statsd_prepare(link, "mygauge", 42, "g", 1.0, tmp, MAX_LINE_LEN, 1);
  strncat(pkt, tmp, PKT_LEN - 1);
  statsd_send(link, pkt);

  statsd_finalize(link);
}
```

[statsd-c-example]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault-example/recipes-memfault/statsd-sampleapp-c

### Example: using Python

See [the full module in our example layer][statsd-python-example].

```python
from statsd import StatsClient

statsd = StatsClient(
    host="localhost",
    port=8125,
    prefix="mypythonapp",
)

statsd.gauge("mygauge", 42)
```

## Viewing Metrics in the Web Application

<p>
  To see detailed reports from a specific device, find the device in{" "}
  <ProjectMagicLink path="/devices">
    <b>Fleet -> Devices</b>
  </ProjectMagicLink>
  , and then open its <b>Timeline</b> tab.
</p>

<p>
  Open{" "}
  <ProjectMagicLink path="/metrics">
    <b>Dashboards -> Metrics</b>
  </ProjectMagicLink>{" "}
  to create Metric Charts that monitor metrics at the fleet level by aggregating
  the data from each device.
</p>

<p>
  To receive notifications when your metrics exceed a certain threshold or meet
  any complex set of criteria, you can set up Alerts. Navigate to{" "}
  <ProjectMagicLink path="/alerts">
    <b>Alerts</b>
  </ProjectMagicLink>{" "}
  using the main menu on the Memfault Web App.
</p>

[statsd-python-example]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault-example/recipes-memfault/statsd-sampleapp-python
[collectd-homepage]: https://collectd.org/
[collectd-write-http]: https://collectd.org/wiki/index.php/Plugin:Write_HTTP
[collectd-chains]: https://collectd.org/wiki/index.php/Chains
[source-yocto-example]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault-example
[source-meta-memfault]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault
[source-memfaultd]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault/recipes-memfault/memfaultd/files/memfaultd
[source-recommended-collectd-conf]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault-example/recipes-extended/collectd/files/collectd.conf
[source-layer-conf]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault/layer.conf
[source-memfaultd-collectd-plugin]:
  https://github.com/memfault/memfault-linux-sdk/blob/main/meta-memfault/recipes-memfault/memfaultd/files/memfaultd/plugins/collectd.c
[source-builtin-conf]:
  https://github.com/memfault/memfault-linux-sdk/tree/main/meta-memfault/recipes-memfault/memfaultd/files/memfaultd/builtin.conf
[docs-linux-getting-started]: /docs/linux/linux-getting-started-guide
[docs-linux-control-plugins]:
  /docs/linux/linux-getting-started-guide#optional-opt-out-of-memfaultd-built-in-plugins
[docs-memfault-device-info]:
  /docs/linux/linux-getting-started-guide#add-a-memfault-device-info-executable-to-your-build
[docs-configuration]: /docs/linux/reference-memfaultd-configuration
[docs-metrics]: /docs/platform/metrics
[docs-timeseries]: /docs/platform/metrics#timeseries
[docs-attributes]: /docs/platform/metrics#attributes
[docs-timeline]: /docs/platform/introduction/#metrics
[docs-metric-charts]: /docs/platform/charts#metric-charts
[docs-alerts]: /docs/platform/alerts
