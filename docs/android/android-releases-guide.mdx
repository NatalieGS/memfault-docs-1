---
id: android-releases-integration-guide
title: Android OTA Integration Guide
sidebar_label: OTA / Release Management
---

:::info

The Bort SDK includes a full OTA update client, from version 3.7.0 onwards. See
[Bort OTA client](android-ota-update-client) below for more information.

:::

This tutorial covers how to manage your Android over-the-air update flow with
Memfault!

## Terminology Overview

Before we get started, let's quickly recap some of the terminology used
throughout the Memfault documentation and how it relates to release management.

At the top level all data in the Memfault UI is encapsulated by the
"Organization" and "Project" where:

- `Organization` - Entity which contains one or more projects and users.
  Generally one organization per company.
- `Project` - A logical warehouse of all the Memfault data related to a
  particular set of devices. Typically there will we one project per discrete
  product line. For example, if your company produces a smart light as well as a
  smart car, these lines would usually be tracked in separate projects. You
  could also create a "dev" project for one-off testing and prototyping.

### Project Level Filtering

Within a "Project", data can be filtered on three dimensions:

- `Device` - An edge device that communicates with the Memfault cloud. You can
  look at data collected at the device level to identify the _exact_ issues
  impacting that unit.
- `Cohort` - A grouping of devices. You will be able to filter data and deploy
  releases by this granularity. For example, you could use a cohort to represent
  devices used for different release stages ("alpha", "beta", "prod") or to
  identify devices by location ("office", "site A", "site B") or a combination
  of both ("Site A Alpha", "Site A Beta", etc). A device is always assigned to
  exactly one "Cohort" at any given time but can freely be moved to another at
  any time.
- `Fleet` - All devices within a Project

### Identifying an Android Device

For a "Device" in a project, several pieces of identifying information are
tracked.

- `Device Serial` / `device_serial` - A unique identifier of a device. The
  system property `ro.serialno` or
  [`android.os.Build.getSerial()` API](<https://developer.android.com/reference/android/os/Build#getSerial()>)
  is used to get this value. Make sure it is unique for every device in the same
  Project, and that the calling app has the requisite permissions to obtain the
  device serial number.
- `Hardware Version` / `hardware_version` - For a given device, the revision of
  the hardware. For more information, see our
  [Hardware Version](platform/software-version-hardware-version.mdx#android)
  documentation.

  By default, the value of the `ro.product.board` system property is used as
  "Hardware Version".

_Note: For any given device, neither of these pieces of information should ever
change._

### Identifying Software

- `Software Type` / `software_type` - A shorthand name representing a software
  package running on your device. For Android projects, the system software is
  always represented by the `android-build` Software Type.
- `Software Version` / `software_version` - Each build of a "software_type" is
  uniquely identified by its "software_version".

For more information, see our
[Software Version](https://mflt.io/android-software-versions) documentation.

### Identifying Firmware Binaries

- `OTA Payload` - This is the
  [`ota_update.zip`](https://source.android.com/devices/tech/ota/tools) that you
  deliver to your device when performing an over-the-air update.
- `Release` - For each "Release" a unique "OTA Payload" can be deployed per
  "hardware_version". A set of "hardware_version" / "OTA Payload" pairs makes up
  a "Release".
- `Deployment` - The act of publishing a "Release" to a "Cohort" generates a
  "Deployment". Once deployed, any device in the given "Cohort" will be able to
  query and update to this Release.

## Getting Started

### OTA Update Client

The Bort SDK (since version 3.7.0) includes an OTA Update Client. Including this
in your build is simple.

### Legacy OTA example app

:::caution

The OTA example app has been replaced with the new OTA Update Client.

:::

A basic example OTA agent application can be found on
[Memfault's Github](https://github.com/memfault/aosp-ota-example). Be sure to
check the `README` and note the limitations of this example code.

### Memfault CLI Tool

Releases can be managed either from the Memfault web UI or via the
[memfault cli tool](https://docs.memfault.com/docs/ci/install-memfault-cli). In
this tutorial we will make use of the CLI client which can be installed via pip:

```bash
$ pip3 install memfault-cli
```

### Organization API Token

This is an auth token that can be used as the "password" to make Memfault API
requests which require Authentication.

Tokens can be generated by going to the Admin / Organization Auth Tokens page.

This token should be passed in as the `--org-token` parameter when using the
Memfault CLI.

For more information about authentication, see
[Authentication](ci/authentication.mdx)

### Project & Organization Slug

When using email & API key authentication, the Memfault CLI tool also needs to
know what organization and project to target. To find the "slugs" of the
organization and project in the Memfault UI:

1. Make sure that you've selected the right project on the top-left
2. Click on "Settings" and then "General Settings"

### Project Key

This is a token that is used when pushing data between a device and the Memfault
cloud. We will be using this to query for OTA Payloads in this tutorial. To
locate this token you will also want to navigate to the "Settings" -> "General"
page in the Memfault UI and copy/paste the token in the "Project Key" section.

## Managing Your First Release

### Create Release

The Hardware Version we will be targeting is matches our products'
`ro.product.board` system property value. In the commands below, please replace
`${YOUR_PRODUCT_BOARD_HERE}` with your products' `ro.product.board` system
property value.

To find the Software Version from the Android build artifacts, we can print the
`out/target/product/$DEVICE/build_fingerprint.txt` file, for example:

```bash
$ cd /dev/smartfridge/
$ cat out/target/product/smartfridge/build_fingerprint.txt
acme_inc/smartfridge/smartfridge:10/QQ2A.200405.005/04302340:user/release-keys
```

To indicate to Memfault we are uploading the OTA payload for the Android system
itself, we need to use `android-build` as the `software_type`.

The complete Memfault CLI invocation to upload the OTA payload:

```bash
$ cd /dev/smartfridge/
$ memfault --org-token ${YOUR_ORG_TOKEN} \
  --org ${YOUR_ORG_SLUG} \
  --project ${YOUR_PROJECT_SLUG} \
  upload-ota-payload \
  --hardware-version ${YOUR_PRODUCT_BOARD_HERE} \
  --software-type android-build \
  --software-version $(< out/target/product/smartfridge/build_fingerprint.txt) \
  --notes "Bug fixes and performance improvements: September 2021" \
  out/dist/path-to-ota-user.zip

INFO: out/dist/path-to-ota-user.zip: uploaded!
INFO: You can view in the UI here:
    <Link to Release in UI>
```

### Versioning

Android versioning configuration is set when creating your project. See the
project settings page to find the `Software Version Source` for a project.

See more information on
[Android software versioning](https://mflt.io/android-software-versions).

**Build Fingerprint Only**

The fingerprint (see above) is the only versioning property. The example above
describes this:

```bash
--software-version $(< out/target/product/smartfridge/build_fingerprint.txt) \
```

**Build Fingerprint and System Property**

A system property is used in combination with the build fingerprint. Modify the
`--software-version` argument to include the build property value e.g.

```bash
--software-version $(< out/target/product/smartfridge/build_fingerprint.txt)::123456789 \
```

where `123456789` is the value of the selected system property. You can find the
value of system properties in the build output folder:
`out/target/product/**/product/build.prop`.

**System Property Only (not recommended)**

```bash
--software-version 123456789 \
```

where `123456789` is the value of the selected system property. You can find the
value of system properties in the build output folder:
`out/target/product/**/product/build.prop`.

:::note Tip

If you are going to be working with the same project you can add standard
arguments as environment variables to your shell init file or via the command
line:

```bash
$ export MEMFAULT_ORG_TOKEN=<Organization Token>
$ export MEMFAULT_ORG=<Organization slug>
$ export MEMFAULT_PROJECT=<Project slug>
```

With these changes, our invocation reduces to:

```bash
$ cd /dev/smartfridge/
$ memfault upload-ota-payload \
  --hardware-version ${YOUR_PRODUCT_BOARD_HERE} \
  --software-type android-build \
  --software-version $(< out/target/product/smartfridge/build_fingerprint.txt) \
  --notes "Bug fixes and performance improvements: September 2021" \
  out/dist/path-to-ota-user.zip

INFO: out/dist/path-to-ota-user.zip: uploaded!
INFO: You can view in the UI here:
    <Link to Release in UI>
```

:::

### Deploy Release

Now let's deploy the release to the `default` cohort.

:::note

Any new device seen that has not explicitly been assigned to a custom cohort
will be part of the `default` cohort. To pre-create devices assigned to a
specific cohort check out our [api-docs](https://api-docs.memfault.com/).

:::

In the UI navigate to "Fleet" -> "Cohorts". Click on the picker under next to
the `default` cohort under "Target Release", select the Release to deploy and
you will be prompted with options that can be performed for the release.

### Query for OTA Payload

:::info

The [OTA Update Client](android-ota-update-client) manages this process!

:::

### Rollback Release

Aborting or Rolling back from a Release which has a firmware regression is easy
to do from the UI. Simply navigate to "Fleet" -> "Cohorts", click on the picker
under "Options" and select the "Abort Rollout" option.
